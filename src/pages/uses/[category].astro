---
import BaseSeo from '$components/base-seo.astro'
import UsesCard from '$components/cards/uses-card.astro'
import UsesLayout from '$layouts/uses-layout.astro'
import { getCollection, type CollectionEntry, getEntries } from 'astro:content'

export async function getStaticPaths() {
	const tools = await getCollection('tools')

	async function getUniqueCategories() {
		let rawCategories: CollectionEntry<'categories'>[] = []

		for (let tool of tools) {
			const categories = await getEntries(tool.data.categories)
			rawCategories = [...rawCategories, ...categories]
		}

		return rawCategories.filter(
			(current, index, data) => data.map((e) => e.id).indexOf(current.id) === index
		)
	}

	let uniqueCategories: CollectionEntry<'categories'>[] = await getUniqueCategories()

	return uniqueCategories.map((category) => ({
		params: { category: category.data.name.toLowerCase() },
		props: {
			tools: tools.filter((tool) =>
				tool.data.categories.some((cat) => cat.id === category.data.name.toLowerCase())
			),
			category: category.data.name
		}
	}))
}

const { tools, category } = Astro.props
---

<UsesLayout>
	<Fragment slot="seo">
		<BaseSeo
			title={`Uses - ${category}`}
			description={`${category} applications used by Ashfid`}
			keywords={['tools', 'programs', 'softwares', 'apps', category]}
			type="website"
		/>
	</Fragment>

	{tools.map((tool) => <UsesCard tool={tool} />)}
</UsesLayout>
